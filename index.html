<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="SPECTRUM Serve Taste Refill">
  <meta name="theme-color" content="#0f172a"/>
  <title>SPECTRUM Serve Taste Refill</title>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --card:#1f2937; --muted:#94a3b8; --text:#f8fafc; --accent:#22c55e; --danger:#ef4444; --warn:#f59e0b; --border:#334155 }
    * { box-sizing: border-box; }
    html, body { margin:0; overflow-x:hidden; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; background: var(--bg); color: var(--text); }
    .wrap { width:100%; max-width: 900px; margin: 0 auto; padding: 16px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; position:sticky; top:0; background: linear-gradient(180deg, rgba(15,23,42,.95), rgba(15,23,42,.85)); backdrop-filter: blur(6px); padding:12px 0; z-index:10 }
    h1 { font-size: 20px; margin:0; letter-spacing:.2px }
    .btn { border:1px solid var(--border); background: #0b1220; color:var(--text); padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:600 }
    .btn:active { transform: translateY(1px); }
    .btn.secondary { background:#0b1220 }
    .grid { display:grid; gap: var(--space,16px) }
    @media (min-width: 860px){ .grid.cols-2 { grid-template-columns: minmax(0,1fr) minmax(0,1fr) } }
    .card { background: var(--card); border:1px solid var(--border); border-radius:16px; padding:16px }
    .card h2 { margin:0 0 8px 0; font-size:16px }
    label { display:block; font-size:12px; color: var(--muted); margin-bottom:6px }
    input[type="number"], select { width:100%; max-width:100%; background:#0b1220; color:var(--text); border:1px solid var(--border); border-radius:12px; padding:12px; font-size:16px }
    .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap }
    .muted { color: var(--muted) }
    .kpis { display:grid; grid-template-columns: repeat(2, 1fr); gap:10px }
    .kpi { background:#0b1220; border:1px solid var(--border); border-radius:14px; padding:12px }
    .kpi .label { font-size:12px; color:var(--muted) }
    .kpi .value { font-size:18px; font-weight:800; margin-top:6px }
    .mini { font-size:12px }
    .line { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 0; border-bottom:1px dashed var(--border) }
    .line:last-child { border-bottom:none }
    .line span { overflow-wrap:anywhere; }
    .hidden { display:none }
    .pos { color: var(--accent) }
    .neg { color: var(--danger) }
    .table { width:100%; border-collapse: collapse; margin-top:6px }
    .table th, .table td { padding:10px 8px; border-bottom:1px dashed var(--border); font-size:14px }
    .table th { text-align:left; color: var(--muted); font-weight:600 }
    .table td:nth-child(2), .table td:nth-child(3), .table td:nth-child(4), .table th:nth-child(2), .table th:nth-child(3), .table th:nth-child(4) { text-align:right }
    .table tr:last-child td { border-bottom:none }
    /* Hide Current Spend (col 2) and Difference (col 4) when no current filter price */
    .hide-cf th:nth-child(2), .hide-cf td:nth-child(2),
    .hide-cf th:nth-child(4), .hide-cf td:nth-child(4) { display:none }
    /* Tighter bottom padding for Pricing card only */
    .card.pricing { padding-bottom: 8px; }
    .card.pricing > *:last-child { margin-bottom: 0; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>SPECTRUM Serve Taste Refill</h1>
      <button id="btnDownloadOnly" class="btn secondary">Download PDF Summary</button>
    </header>

    <div class="grid cols-2">
      <section class="card">
        <h2>Selections</h2>
        <div class="grid">
          <div class="row mini">
            <input id="customerView" type="checkbox" />
            <label for="customerView" style="margin:0">Customer view</label>
          </div>
          <div>
            <label>Housing</label>
            <select id="housingSelect"></select>
          </div>
          <div>
            <label>Cartridge</label>
            <select id="cartridgeSelect"></select>
          </div>
          <div class="row">
            <div style="flex:1; min-width:180px">
              <label>Housing Pack</label>
              <select id="housingPack">
                <option value="each">Each</option>
                <option value="box">Box (20% off)</option>
              </select>
            </div>
            <div style="flex:1; min-width:180px">
              <label>Cartridge Pack</label>
              <select id="cartridgePack">
                <option value="each">Each</option>
                <option value="box">Box (20% off)</option>
              </select>
            </div>
          </div>

          <div id="discountInputs" class="row">
            <div style="flex:1; min-width:160px">
              <label>Housing discount %</label>
              <input id="discountHousing" type="number" inputmode="decimal" step="0.5" min="0" max="60" value="0" />
            </div>
            <div style="flex:1; min-width:160px">
              <label>Cartridge discount %</label>
              <input id="discountCartridge" type="number" inputmode="decimal" step="0.5" min="0" max="60" value="0" />
            </div>
          </div>

          <div>
            <label>Volumes</label>
            <select id="qtyPeriod">
              <option value="week">per week</option>
              <option value="month">per month</option>
              <option value="year">per year</option>
            </select>
          </div>
          <div class="row">
            <div style="flex:1; min-width:160px">
              <label>Housing quantity</label>
              <input id="qtyHousing" type="number" inputmode="decimal" step="1" min="0" placeholder="e.g. 10" />
            </div>
            <div style="flex:1; min-width:160px">
              <label>Cartridge quantity</label>
              <input id="qtyCartridge" type="number" inputmode="decimal" step="1" min="0" placeholder="e.g. 50" />
            </div>
          </div>
          <div>
            <label>Current Filter Pricing (£)</label>
            <input id="currentFilter" type="number" inputmode="decimal" step="0.01" min="0" placeholder="e.g. 10.00" onblur="this.value = this.value ? (+this.value).toFixed(2) : ''" />
          </div>
        </div>
      </section>

      <section class="card pricing">
        <h2>Pricing</h2>
        <div id="pricingContent"></div>
        <p class="mini muted" style="margin-top:8px">All numbers in GBP. Box prices are 20% off each list as provided.</p>
      </section>

      <section class="card" id="comparisonCard">
        <h2>Comparison</h2>
        <table class="table" id="compTable">
          <thead>
            <tr>
              <th>Change Outs</th>
              <th>Current Spend</th>
              <th id="compSpendHeader">New Spend</th>
              <th>Difference</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>1 Filter</td><td id="comp1Current">—</td><td id="comp1Our">—</td><td id="comp1Diff">—</td></tr>
            <tr><td>2 Filters</td><td id="comp2Current">—</td><td id="comp2Our">—</td><td id="comp2Diff">—</td></tr>
            <tr><td>3 Filters</td><td id="comp3Current">—</td><td id="comp3Our">—</td><td id="comp3Diff">—</td></tr>
            <tr><td>4 Filters</td><td id="comp4Current">—</td><td id="comp4Our">—</td><td id="comp4Diff">—</td></tr>
          </tbody>
        </table>
        <p class="mini muted" style="margin-top:8px">Positive difference = saving vs current filter price.</p>
      </section>
    </div>

  </div>

  <script>
    // ===== Data from spreadsheet (static snapshot) =====
    const DATA = {
      housings: [
        { key:'none', name:'Housing in place (no cost)', listEach:0, listBox:0 },
        { key:'st-rh', name:'ST-RH: SPECTRUM Branded Serve Taste Refillable Housing', listEach:15.00, listBox:12.00 },
        { key:'stl-1-1-4-nl', name:'STL-1-1/4-NL: Unbranded/No Label Taste Refillable Housing', listEach:18.75, listBox:16.00 },
        { key:'private', name:'Private Branded Taste Refillable Housing', listEach:19.75, listBox:17.00 },
      ],
      cartridges: [
        { key:'st-rr', name:'ST-RR : SPECTRUM Serve Taste Refillable Replacement Cartridge', listEach:5.50, listBox:4.40 },
        { key:'stp-rr', name:'STP-RR : SPECTRUM Serve Taste Phosphate Refillable Replacement Cartridge', listEach:6.75, listBox:5.40 },
        { key:'stf-rr', name:'STF-RR : SPECTRUM Serve Taste FibreOnyx with Lentik™ Replacement Cartridge', listEach:16.00, listBox:12.80 },
        { key:'stfp-rr', name:'STFP-RR : SPECTRUM Serve Taste FibreOnyx with Phosphate Refillable Replacement Cartridge', listEach:17.25, listBox:13.80 },
        { key:'stfplus-rr', name:'STF+-RR : SPECTRUM Serve Taste FibreOnyx+ with Lentik™ Replacement Cartridge', listEach:20.50, listBox:16.40 },
        { key:'stfpplus-rr', name:'STFP+-RR : SPECTRUM Serve Taste FibreOnyx+ with Phosphate Refillable Replacement Cartridge', listEach:21.75, listBox:17.40 },
      ]
    }

    const fmt = new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' })

    // ==== Helpers ====
    function roundDownPenny(val){ return Math.floor((Number(val) + 1e-9) * 100) / 100 }
    function annualise(qty, period){ qty = +qty||0; if(qty<=0) return 0; if(period==='week') return qty*52; if(period==='month') return qty*12; return qty }
    function getItem(arr, key){ return arr.find(x=>x.key===key) || arr[0] }
    function save(state){ localStorage.setItem('refill_calc_v1', JSON.stringify(state)) }

    // ==== State ====
    const stored = JSON.parse(localStorage.getItem('refill_calc_v1')||'{}')
    const state = {
      housingKey: stored.housingKey || 'none',
      housingPack: stored.housingPack || 'each',
      cartridgeKey: stored.cartridgeKey || DATA.cartridges[0].key,
      cartridgePack: stored.cartridgePack || 'each',
      discountHousing: Number.isFinite(+stored.discountHousing) ? +stored.discountHousing : (Number.isFinite(+stored.discount)? +stored.discount: 0),
      discountCartridge: Number.isFinite(+stored.discountCartridge) ? +stored.discountCartridge : (Number.isFinite(+stored.discount)? +stored.discount: 0),
      customerView: !!stored.customerView,
      qtyHousing: Number.isFinite(+stored.qtyHousing)? +stored.qtyHousing : 0,
      qtyCartridge: Number.isFinite(+stored.qtyCartridge)? +stored.qtyCartridge : 0,
      qtyPeriod: (stored.qtyPeriod==='day' ? 'week' : (stored.qtyPeriod||'week')),
      currentFilter: Number.isFinite(+stored.currentFilter)? +stored.currentFilter : 0,
    }

    // ==== Elements ====
    const els = {
      housingSelect: document.getElementById('housingSelect'),
      housingPack: document.getElementById('housingPack'),
      cartridgeSelect: document.getElementById('cartridgeSelect'),
      cartridgePack: document.getElementById('cartridgePack'),
      discountHousing: document.getElementById('discountHousing'),
      discountCartridge: document.getElementById('discountCartridge'),
      discountRow: document.getElementById('discountInputs'),
      customerView: document.getElementById('customerView'),
      qtyHousing: document.getElementById('qtyHousing'),
      qtyCartridge: document.getElementById('qtyCartridge'),
      qtyPeriod: document.getElementById('qtyPeriod'),
      currentFilter: document.getElementById('currentFilter'),
      pricingContent: document.getElementById('pricingContent'),
      compTable: document.getElementById('compTable'),
    }

    // ==== Build selectors ====
    function build(){
      els.housingSelect.innerHTML = DATA.housings.map(h=>`<option value="${h.key}" ${h.key===state.housingKey?'selected':''}>${h.name}</option>`).join('')
      els.cartridgeSelect.innerHTML = DATA.cartridges.map(c=>`<option value="${c.key}" ${c.key===state.cartridgeKey?'selected':''}>${c.name}</option>`).join('')

      els.housingPack.value = state.housingPack
      els.cartridgePack.value = state.cartridgePack
      els.discountHousing.value = state.discountHousing
      els.discountCartridge.value = state.discountCartridge
      els.customerView.checked = state.customerView
      els.qtyHousing.value = state.qtyHousing || ''
      els.qtyCartridge.value = state.qtyCartridge || ''
      els.qtyPeriod.value = state.qtyPeriod
      els.currentFilter.value = state.currentFilter || ''

      compute()
    }

    // ==== Compute & render ====
    function compute(){
      const view = !!state.customerView
      const h = getItem(DATA.housings, state.housingKey)
      const c = getItem(DATA.cartridges, state.cartridgeKey)

      const hPrice = state.housingPack==='box' ? (h.listBox||0) : (h.listEach||0)
      const cPrice = state.cartridgePack==='box' ? (c.listBox||0) : (c.listEach||0)
      const rateH = (+state.discountHousing||0)/100
      const rateC = (+state.discountCartridge||0)/100

      const hDisc = hPrice * rateH
      const cDisc = cPrice * rateC
      const hAfter = roundDownPenny(hPrice - hDisc)
      const cAfter = roundDownPenny(cPrice - cDisc)
      const base = roundDownPenny(hPrice + cPrice)
      const totalDisc = roundDownPenny((hPrice + cPrice) - (hAfter + cAfter))
      const subtotal = roundDownPenny(hAfter + cAfter)

      // Discount inputs visibility under Customer view
      els.discountRow.classList.toggle('hidden', view)

      // Pricing panel content
      const lines = []
      if(view){
        lines.push(`<div class="line"><strong>Housing price</strong><strong>${fmt.format(hAfter)}</strong></div>`)
        lines.push(`<div class="line"><strong>Cartridge price</strong><strong>${fmt.format(cAfter)}</strong></div>`)
        lines.push(`<div class="line"><strong>Combined System Price</strong><strong>${fmt.format(subtotal)}</strong></div>`)
      } else {
        lines.push(`<div class="line"><span class="muted">List price of housing</span><span>${fmt.format(hPrice)} (${state.housingPack})</span></div>`)
        lines.push(`<div class="line"><span class="muted">Housing discount</span><span>− ${fmt.format(hDisc)}</span></div>`)
        lines.push(`<div class="line"><strong>Housing price</strong><strong>${fmt.format(hAfter)}</strong></div>`)
        lines.push(`<div class="line"><span class="muted">List price of cartridge</span><span>${fmt.format(cPrice)} (${state.cartridgePack})</span></div>`)
        lines.push(`<div class="line"><span class="muted">Cartridge discount</span><span>− ${fmt.format(cDisc)}</span></div>`)
        lines.push(`<div class="line"><strong>Cartridge price</strong><strong>${fmt.format(cAfter)}</strong></div>`)
        lines.push(`<div class="line"><span class="muted">Base (before discount)</span><span>${fmt.format(base)}</span></div>`)
        lines.push(`<div class="line"><span class="muted">Total discount</span><span>− ${fmt.format(totalDisc)}</span></div>`)
        lines.push(`<div class="line"><strong>Combined System Price</strong><strong>${fmt.format(subtotal)}</strong></div>`)
        const dH = (+state.discountHousing||0); const dC = (+state.discountCartridge||0); const pH = dH.toFixed(1).replace(/\.0$/, ''); const pC = dC.toFixed(1).replace(/\.0$/, '')
        lines.push(`<div class="kpis" style="margin-top:12px"><div class="kpi"><div class="label">Discounts applied</div><div class="value">${(dH===dC)? `${pH}%` : `H ${pH}% · C ${pC}%`}</div></div></div>`)
      }

      // Annual block
      const aH = annualise(state.qtyHousing, state.qtyPeriod)
      const aC = annualise(state.qtyCartridge, state.qtyPeriod)
      if(aH>0 || aC>0){
        const annualH = roundDownPenny(hAfter * aH)
        const annualC = roundDownPenny(cAfter * aC)
        lines.push(`<div style="margin-top:10px">`)
        lines.push(`<div class="line"><span class="muted">Annual housing qty</span><span>${aH.toLocaleString('en-GB')}</span></div>`)
        lines.push(`<div class="line"><span class="muted">Annual cartridge qty</span><span>${aC.toLocaleString('en-GB')}</span></div>`)
        lines.push(`<div class="line"><span class="muted">Housing × annual qty</span><span>${fmt.format(annualH)}</span></div>`)
        lines.push(`<div class="line"><span class="muted">Cartridge × annual qty</span><span>${fmt.format(annualC)}</span></div>`)
        lines.push(`<div class="line"><strong>Annual total</strong><strong>${fmt.format(roundDownPenny(annualH + annualC))}</strong></div>`)
        // Annual saving only when Current Filter Pricing AND Cartridge qty provided
        const cf = +state.currentFilter || 0
        if(cf>0 && aC>0){
          const annualCurr = roundDownPenny(cf * aC)
          const annualOur = roundDownPenny(annualH + annualC)
          const saving = roundDownPenny(annualCurr - annualOur)
          const cls = saving>0 ? 'pos' : (saving<0 ? 'neg' : '')
          lines.push(`<div class="line ${cls}"><strong>Annual saving</strong><strong>${fmt.format(saving)}</strong></div>`)
        }
        lines.push(`</div>`)
      }

      try { if (els.pricingContent) { els.pricingContent.innerHTML = lines.join('\n'); } } catch(e) { console && console.warn && console.warn('Render pricingContent failed', e); }

      // Comparison table
      const cf = +state.currentFilter || 0
      const thead = els.compTable.querySelector('thead')
      const tbody = els.compTable.querySelector('tbody')
      if(cf>0){
        thead.innerHTML = `<tr><th>Change Outs</th><th>Current Spend</th><th>New Spend</th><th>Difference</th></tr>`
      } else {
        thead.innerHTML = `<tr><th>Change Outs</th><th>Spend</th></tr>`
      }
      const rows = [1,2,3,4].map(n=>{
        const curr = roundDownPenny(cf * n)
        const ours = roundDownPenny(hAfter + cAfter * n)
        const diff = roundDownPenny(curr - ours)
        if(cf>0){
          const diffCls = diff>0 ? 'pos' : (diff<0 ? 'neg' : '')
          return `<tr><td>${n} ${n===1?'Filter':'Filters'}</td><td>${fmt.format(curr)}</td><td>${fmt.format(ours)}</td><td class="${diffCls}">${fmt.format(diff)}</td></tr>`
        } else {
          return `<tr><td>${n} ${n===1?'Filter':'Filters'}</td><td>${fmt.format(ours)}</td></tr>`
        }
      }).join('')
      tbody.innerHTML = rows
      els.compTable.classList.toggle('hide-cf', !(cf>0))

      save(state)
    }

    // ==== Events ====
    els.housingSelect.addEventListener('change', ()=>{ state.housingKey = els.housingSelect.value; compute() })
    els.cartridgeSelect.addEventListener('change', ()=>{ state.cartridgeKey = els.cartridgeSelect.value; compute() })
    els.housingPack.addEventListener('change', ()=>{ state.housingPack = els.housingPack.value; compute() })
    els.cartridgePack.addEventListener('change', ()=>{ state.cartridgePack = els.cartridgePack.value; compute() })
    els.discountHousing.addEventListener('input', ()=>{ state.discountHousing = +els.discountHousing.value; compute() })
    els.discountCartridge.addEventListener('input', ()=>{ state.discountCartridge = +els.discountCartridge.value; compute() })
    els.customerView.addEventListener('change', ()=>{ state.customerView = els.customerView.checked; compute() })
    els.qtyHousing.addEventListener('input', ()=>{ state.qtyHousing = +els.qtyHousing.value; compute() })
    els.qtyCartridge.addEventListener('input', ()=>{ state.qtyCartridge = +els.qtyCartridge.value; compute() })
    els.qtyPeriod.addEventListener('change', ()=>{ state.qtyPeriod = els.qtyPeriod.value; compute() })
    els.currentFilter.addEventListener('input', ()=>{ state.currentFilter = +els.currentFilter.value; compute() })

    // ==== Initial render ====
    build()

    // ===== PDF Summary (styled to match UI) =====
    function buildSummaryHTML(h,c,hAfter,cAfter,subtotal,annualBlock,compHead,compRows){
      return `<!doctype html><html><head><meta charset='utf-8'>
        <title>Summary</title>
        <style>
          body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:#fff;color:#000;padding:24px}
          h1{font-size:20px;margin:0 0 12px;color:#000}
          .line{display:flex;justify-content:space-between;gap:8px;padding:8px 0;border-bottom:1px dashed #ccc}
          .line:last-child{border-bottom:none}
          table{width:100%;border-collapse:collapse;margin-top:6px}
          th,td{padding:10px 8px;border-bottom:1px dashed #ccc;font-size:14px}
          th{text-align:left;color:#555}
          td:nth-child(2), td:nth-child(3), td:nth-child(4), th:nth-child(2), th:nth-child(3), th:nth-child(4){text-align:right}
          .pos{color:green} .neg{color:red}
        </style></head><body>
        <h1>SPECTRUM Serve Taste Refill — Summary</h1>
        <section>
          <h2>Your Price Breakdown</h2>
          <div class="line"><span>${h.name}</span><span>${fmt.format(hAfter)}</span></div>
          <div class="line"><span>${c.name}</span><span>${fmt.format(cAfter)}</span></div>
          <div class="line"><strong>Combined System Price</strong><strong>${fmt.format(subtotal)}</strong></div>
          ${annualBlock}
        </section>
        <section>
          <h2>Your Cost Saving Breakdown Per Changeout</h2>
          <table><thead>${compHead}</thead><tbody>${compRows}</tbody></table>
          <p style="font-size:12px;color:#555">Positive difference = saving vs current filter price.</p>
        </section>
</body></html>`
    }

    function openPrintSummary(h,c,hAfter,cAfter,subtotal,annualBlock,compHead,compRows){
      const html = buildSummaryHTML(h,c,hAfter,cAfter,subtotal,annualBlock,compHead,compRows)
      const w = window.open('', '_blank')
      if(!w){ alert('Please allow popups to create the PDF'); return }
      w.document.open(); w.document.write(html); w.document.close();
      w.focus();
      try{ w.print(); }catch{}
    }
  // ==== Restore Download PDF button functionality ====
    document.getElementById('btnDownloadOnly').addEventListener('click', ()=>{
      const h = getItem(DATA.housings, state.housingKey)
      const c = getItem(DATA.cartridges, state.cartridgeKey)
      const hPrice = state.housingPack==='box'? h.listBox : h.listEach
      const cPrice = state.cartridgePack==='box'? c.listBox : c.listEach
      const hAfter = roundDownPenny(hPrice - (hPrice * (+state.discountHousing||0)/100))
      const cAfter = roundDownPenny(cPrice - (cPrice * (+state.discountCartridge||0)/100))
      const subtotal = roundDownPenny(hAfter + cAfter)

      // Annual block markup
      const aH = annualise(state.qtyHousing, state.qtyPeriod)
      const aC = annualise(state.qtyCartridge, state.qtyPeriod)
      let annualBlock = ''
      if(aH>0 || aC>0){
        const annualH = roundDownPenny(hAfter * aH)
        const annualC = roundDownPenny(cAfter * aC)
        const annualTotal = roundDownPenny(annualH + annualC)
        annualBlock = `<div style=\"margin-top:10px\">`
          + `<div class=\"line\"><span class=\"muted\">Annual housing qty</span><span>${aH.toLocaleString('en-GB')}</span></div>`
          + `<div class=\"line\"><span class=\"muted\">Annual cartridge qty</span><span>${aC.toLocaleString('en-GB')}</span></div>`
          + `<div class=\"line\"><span class=\"muted\">Housing × annual qty</span><span>${fmt.format(annualH)}</span></div>`
          + `<div class=\"line\"><span class=\"muted\">Cartridge × annual qty</span><span>${fmt.format(annualC)}</span></div>`
          + `<div class=\"line\"><strong>Annual total</strong><strong>${fmt.format(annualTotal)}</strong></div>`
        // Annual saving only when Current Filter Pricing AND Cartridge qty provided
        const cf = +state.currentFilter || 0
        if(cf>0 && aC>0){
          const annualCurr = roundDownPenny(cf * aC)
          const saving = roundDownPenny(annualCurr - annualTotal)
          const cls = saving>0? 'pos' : (saving<0? 'neg':'')
          annualBlock += `<div class=\"line ${cls}\"><strong>Annual saving</strong><strong>${fmt.format(saving)}</strong></div>`
        }
        annualBlock += `</div>`
      }

      // Comparison block
      const cf = +state.currentFilter || 0
      let compHead, compRows
      if(cf>0){
        compHead = `<tr><th>Change Outs</th><th>Current Spend</th><th>New Spend</th><th>Difference</th></tr>`
      } else {
        compHead = `<tr><th>Change Outs</th><th>Spend</th></tr>`
      }
      compRows = [1,2,3,4].map(n=>{
        const curr = roundDownPenny(cf * n)
        const ours = roundDownPenny(hAfter + cAfter * n)
        const diff = roundDownPenny(curr - ours)
        if(cf>0){
          const diffCls = diff>0? 'pos': (diff<0? 'neg':'')
          return `<tr><td>${n} ${n===1?'Filter':'Filters'}</td><td>${fmt.format(curr)}</td><td>${fmt.format(ours)}</td><td class=\"${diffCls}\">${fmt.format(diff)}</td></tr>`
        } else {
          return `<tr><td>${n} ${n===1?'Filter':'Filters'}</td><td>${fmt.format(ours)}</td></tr>`
        }
      }).join('')

      openPrintSummary(h,c,hAfter,cAfter,subtotal,annualBlock,compHead,compRows)
    })
   
  </script>
</body>
</html>